---
- name: Deploying the PHP Application to Dev Environment
  become: true
  hosts: todo

  tasks:
    - name: Install remi and RHEL repo
      ansible.builtin.yum:
        name:
          - https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm
          - dnf-utils
          - http://rpms.remirepo.net/enterprise/remi-release-9.rpm
        disable_gpg_check: yes

    - name: Install httpd on the web server
      ansible.builtin.yum:
        name: httpd
        state: present

    - name: Ensure httpd is started and enabled
      ansible.builtin.service:
        name: httpd
        state: started
        enabled: yes

    - name: Install PHP
      ansible.builtin.yum:
        name:
          - php
          - php-mysqlnd
          - php-gd
          - php-curl
          - unzip
          - php-common
          - php-mbstring
          - php-opcache
          - php-intl
          - php-xml
          - php-fpm
          - php-json
        enablerepo: php:remi-8.3
        state: present

    - name: Ensure php-fpm is started and enabled
      ansible.builtin.service:
        name: php-fpm
        state: started
        enabled: yes

    - name: Download the artifact
      ansible.builtin.get_url:
        url: http://3.101.140.173:8082/artifactory/generic-local/php-todo-app
        dest: /home/ec2-user/
        url_username: admin
        url_password: cmVmdGtuOjAxOjE3Mzc5MzE1ODA6WmdVSFVCYUVUcFhZaFRqUEV4OFhkaG5KYUlm

    - name: Unzip the artifacts
      ansible.builtin.unarchive:
        src: /home/ec2-user/php-todo
        dest: /home/ec2-user/
        remote_src: yes

    - name: Deploy the code
      ansible.builtin.copy:
        src: /home/ec2-user/var/lib/jenkins/workspace/php-todo_main/
        dest: /var/www/html/
        force: yes
        remote_src: yes

    - name: Disable default Apache site on Red Hat-based systems
      become: true
      block:
        - name: Stop httpd service
          ansible.builtin.command: systemctl stop httpd
          ignore_errors: yes

        - name: Disable httpd service
          ansible.builtin.command: systemctl disable httpd
          ignore_errors: yes

        - name: Check if welcome.conf exists
          ansible.builtin.stat:
            path: /etc/httpd/conf.d/welcome.conf
          register: welcome_conf_stat
          ignore_errors: true

        - name: Move welcome.conf if it exists
          ansible.builtin.command: mv /etc/httpd/conf.d/welcome.conf /etc/httpd/conf.d/welcome.conf.disabled
          when: welcome_conf_stat.stat.exists
          ignore_errors: yes

        - name: Restart httpd service
          ansible.builtin.command: systemctl restart httpd
          ignore_errors: yes
      when: "'Red Hat' in ansible_distribution and ansible_distribution_major_version|int >= 7"
